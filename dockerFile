# 1. Image de base SteamCMD pré-installée
FROM cm2network/steamcmd:latest

# L'utilisateur par défaut est 'steam' (UID 1000) et le WORKDIR est /home/steam

# 2. Variables d'environnement
ENV SERVER_DIR="/home/steam/necesse_server" \
    NECESSE_APPID="1169370"

# 3. Installation Initiale du Serveur Necesse
# Créer le répertoire et télécharger le jeu.
# Le répertoire d'installation est forcé pour le rendre facile à monter (volumes).
# Note : Le binaire SteamCMD est généralement /home/steam/steamcmd/steamcmd.sh dans cette image.
RUN mkdir -p ${SERVER_DIR} \
    && /home/steam/steamcmd/steamcmd.sh +force_install_dir ${SERVER_DIR} +login anonymous +app_update ${NECESSE_APPID} validate +quit

# 4. Ajout des scripts d'exécution
# Nous utilisons les scripts précédents pour la mise à jour au lancement.

# 4b. Revenir à ROOT pour l'opération de CHMOD sur un répertoire système.
# (Note: Si l'utilisateur 'steam' avait été root au moment de la copie, ce ne serait pas nécessaire, 
# mais l'image cm2network/steamcmd passe à steam très tôt.)
USER root

COPY entrypoint.sh run.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/run.sh

# 4c. Repasser à l'utilisateur non-root 'steam' (obligatoire pour SteamCMD et le serveur de jeu)

USER steam

# 5. Configuration finale du conteneur
EXPOSE 14100/tcp
EXPOSE 14100/udp

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]